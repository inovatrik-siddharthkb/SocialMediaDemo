<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Detail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-2xl mx-auto px-4 h-14 flex items-center">
            <a th:href="@{/feed}" class="flex items-center text-gray-600 hover:text-blue-600 font-medium transition">
                <span data-lucide="arrow-left" class="w-5 h-5 mr-2"></span>
                Back to Feed
            </a>
        </div>
    </nav>

    <main class="max-w-2xl mx-auto p-4 pt-6">

        <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden" th:object="${post}">
            <div class="p-4 flex items-center border-b border-gray-100">
                <a th:href="@{/user/{u}(u=*{author.username})}" class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3 hover:opacity-80 transition">
                    <span class="font-bold text-blue-600 text-sm" th:text="${#strings.substring(post.author.name,0,1)}">A</span>
                </a>
                <div>
                    <a th:href="@{/user/{u}(u=*{author.username})}" class="font-semibold text-gray-900 text-sm hover:underline" th:text="*{author.name}">Author</a>
                    <p class="text-xs text-gray-500" th:text="${#dates.format(post.createdAt, 'MMM dd, HH:mm')}">Time</p>
                </div>
            </div>

            <div class="p-4">
                <p class="text-gray-800 text-lg leading-relaxed" th:text="*{text}">Content</p>
            </div>

            <div th:if="*{mediaList != null and !mediaList.empty}" class="w-full">
                <img th:src="@{*{mediaList.get(0).url}}" class="w-full object-cover" th:if="*{mediaList.get(0).type.name() == 'IMAGE'}">
            </div>

            <div class="flex justify-around p-2 border-t border-gray-100 bg-gray-50">
                 <form th:action="@{/api/posts/{id}/like(id=*{id})}" onsubmit="handleLike(event)" class="w-full text-center">
                    <input th:if="*{isLiked}" type="hidden" name="_method" value="DELETE" />
                    <button type="submit" class="flex items-center justify-center space-x-2 w-full py-2 rounded transition" th:classappend="*{isLiked} ? 'text-blue-600 font-bold' : 'text-gray-600 hover:bg-gray-200'">
                        <span data-lucide="thumbs-up" class="w-5 h-5"></span>
                        <span th:text="*{likeCount}">0</span>
                    </button>
                </form>
                <div class="flex items-center justify-center space-x-2 w-full py-2 text-gray-600">
                    <span data-lucide="message-circle" class="w-5 h-5"></span>
                    <span th:text="*{commentCount}">0</span>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
            <form th:action="@{/api/posts/{id}/comment(id=${post.id})}" onsubmit="handleComment(event)" class="flex gap-3">
                <input type="text" name="text" placeholder="Write a comment..." required
                       class="flex-grow bg-gray-100 px-4 py-2 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="text-blue-600 font-bold hover:text-blue-700 text-sm">Post</button>
            </form>
        </div>

        <div class="space-y-4">
            <div th:each="comment : ${post.comments}" class="flex gap-3 group">
                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0 mt-1">
                    <span class="text-xs font-bold text-gray-500" th:text="${#strings.substring(comment.author.name,0,1)}">U</span>
                </div>
                <div class="flex-grow">
                    <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm inline-block min-w-[150px]">
                        <div class="flex justify-between items-start">
                            <p class="font-bold text-xs text-gray-900 mb-0.5" th:text="${comment.author.name}">Name</p>
                            
                            <button th:if="${currentUser != null and currentUser.username == comment.author.username}"
                                    th:onclick="'deleteComment(' + ${comment.id} + ')'"
                                    class="text-gray-400 hover:text-red-500 transition ml-2" title="Delete Comment">
                                <span data-lucide="trash-2" class="w-3 h-3"></span>
                            </button>
                        </div>
                        <p class="text-sm text-gray-800" th:text="${comment.text}">Comment text</p>
                    </div>
                    <div class="text-xs text-gray-400 mt-1 ml-2">
                        <span th:text="${#dates.format(comment.post.createdAt, 'HH:mm')}">Time</span>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        lucide.createIcons();

        async function handleLike(event) {
            event.preventDefault();
            const form = event.target;
            const action = form.getAttribute('action');
            const methodInput = form.querySelector('input[name="_method"]');
            const method = (methodInput && methodInput.value === 'DELETE') ? 'DELETE' : 'POST';

            try {
                const response = await fetch(action, { method: method });
                if (response.ok) window.location.reload();
            } catch (err) { console.error(err); }
        }

        async function handleComment(event) {
            event.preventDefault();
            const form = event.target;
            const action = form.getAttribute('action');
            const text = form.querySelector('input[name="text"]').value;

            try {
                const response = await fetch(action, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                if (response.ok) window.location.reload();
            } catch (err) { console.error(err); }
        }

        async function deleteComment(commentId) {
            if (!confirm("Are you sure you want to delete this comment?")) return;
            
            try {
                const response = await fetch('/api/posts/comments/' + commentId, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    window.location.reload();
                } else {
                    alert("Failed to delete comment. You might not have permission.");
                }
            } catch (err) { 
                console.error(err); 
                alert("Error connecting to server.");
            }
        }
    </script>
</body>
</html>